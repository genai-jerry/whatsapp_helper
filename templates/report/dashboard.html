{% extends "base.html" %}

{% block title %}
Report
{% endblock %}

{% block content %}

<div class="row">
    <div class="col-md-6">
        <h2>Overall Report</h2>
        <table class="table table-striped" id="overallReportTable">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Count</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                <!-- Overall report data will be inserted here -->
            </tbody>
        </table>
    </div>
    <div class="col-md-6">
        <h2>Custom Report</h2>
        <label for="start_date">Start Date:</label>
        <input type="date" id="start_date">

        <label for="end_date">End Date:</label>
        <input type="date" id="end_date">

        <button id="generate_report">Generate Report</button>

        <div class="table-responsive">
            <table class="table table-striped" id="customReportTable">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Custom report data will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function fetchAndDisplayReport(startDate, endDate, tableBody) {
    $.ajax({
        url: `/dashboard/report?start_date=${startDate}&end_date=${endDate}`,
        method: 'GET',
        dataType: 'json',
        success: function(report) {
            tableBody.empty();  // clear previous table data
            report = JSON.parse(report);
            for (const data of report) {
                row = $('<tr></tr>');
                row.append($('<td></td>').text(data.name || 'Call Pending'));
                row.append($('<td></td>').text(data.count));
                row.append($('<td></td>').text(data.percentage));
                tableBody.append(row);
            }
        }
    });
}

$(document).ready(function() {
    currentDate = new Date();
    startDate = new Date(2023, 0, 1);
    endDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0);
    overallReportTable = $('#overallReportTable');
    customReportTable = $('#customReportTable');
    startDateInput = $('#start_date');
    endDateInput = $('#end_date');
    // Set default values for start and end date inputs
    startDateInput.val(formatDate(startDate));
    endDateInput.val(formatDate(endDate));
    // Fetch overall report data
    fetchAndDisplayReport(formatDate(startDate), formatDate(endDate), overallReportTable.find('tbody'));
    // Fetch custom report data for the last 7 days
    last7DaysStartDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() - 7);
    last7DaysEndDate = currentDate;
    fetchAndDisplayReport(formatDate(last7DaysStartDate), formatDate(last7DaysEndDate), customReportTable.find('tbody'));
    // Set last 7 days start and end date as the default values for start and end date inputs
    startDateInput.val(formatDate(last7DaysStartDate));
    endDateInput.val(formatDate(last7DaysEndDate));
    function formatDate(date) {
        year = date.getFullYear();
        month = String(date.getMonth() + 1).padStart(2, '0');
        day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
});

$('#generate_report').click(function() {
    startDate = $('#start_date').val();
    endDate = $('#end_date').val();
    tableBody = $('#customReportTable').find('tbody');

    fetchAndDisplayReport(startDate, endDate, tableBody);
});
</script>
{% endblock %}