<div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createTaskModalLabel">Create New Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Add feedback message container -->
        <div id="taskFeedback" class="alert" style="display: none;"></div>
        
        <form id="createTaskForm">
          <div class="mb-3">
            <label for="opportunitySearch" class="form-label">Search Opportunities</label>
            <input type="text" class="form-control" id="opportunitySearch" name="opportunity_search" placeholder="Start typing to search..." required>
            <input type="hidden" id="selectedOpportunityId" name="opportunity_id">
            <ul id="opportunityList" class="list-group mt-2"></ul>
          </div>

          <div class="mb-3">
            <label for="dueDate" class="form-label">Due Date</label>
            <input type="date" class="form-control" id="dueDate" name="due_date" required>
          </div>

          <div class="mb-3">
            <label for="taskDetails" class="form-label">Task Details</label>
            <textarea class="form-control" id="taskDetails" name="task_details" rows="3" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="submitCreateTask">Create Task</button>
      </div>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
  var opportunitySearch = $('#opportunitySearch');
  var opportunityList = $('#opportunityList');
  var selectedOpportunityId = $('#selectedOpportunityId');
  var searchTimeout;
  var taskFeedback = $('#taskFeedback');

  function showFeedback(message, isSuccess) {
    taskFeedback.removeClass('alert-success alert-danger').addClass(isSuccess ? 'alert-success' : 'alert-danger');
    taskFeedback.text(message).show();
    setTimeout(function() {
      taskFeedback.hide();
    }, 5000);
  }

  opportunitySearch.on('input', function() {
    clearTimeout(searchTimeout);
    var query = $(this).val();

    if (query.length < 2) {
      opportunityList.empty();
      return;
    }

    searchTimeout = setTimeout(function() {
      $.ajax({
        url: '{{ url_for("opportunity.search_partial_opportunities") }}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ query: query }),
        success: function(data) {
          opportunityList.empty();
          data.forEach(function(opportunity) {
            var listItem = $('<li>')
              .addClass('list-group-item list-group-item-action')
              .text(opportunity.name + ' (' + opportunity.email + ') - ' + opportunity.phone)
              .data('id', opportunity.id)
              .data('name', opportunity.name);
            opportunityList.append(listItem);
          });
        },
        error: function(xhr, status, error) {
          console.error('Error searching opportunities:', error);
          showFeedback('Error searching opportunities. Please try again.', false);
        }
      });
    }, 300);
  });

  opportunityList.on('click', 'li', function() {
    var selected = $(this);
    selectedOpportunityId.val(selected.data('id'));
    opportunitySearch.val(selected.data('name'));
    opportunityList.empty();
  });

  $('#submitCreateTask').click(function() {
    var form = $('#createTaskForm');
    var formData = new FormData(form[0]);

    $.ajax({
      url: '/task',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(response) {
        showFeedback(response.message, true);
        form[0].reset();
        opportunityList.empty();
        selectedOpportunityId.val('');
        setTimeout(function() {
          $('#createTaskModal').modal('hide');
        }, 2000);
      },
      error: function(xhr, status, error) {
        console.error(error);
        showFeedback('An error occurred while creating the task. Please try again.', false);
      }
    });
  });
});
</script>
