{% extends "base.html" %}

{% block title %}
List of Appointments
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>List of Appointments</h2>
    <table class="table table-striped" id="appointmentsTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Mentor</th>
                <th>Appointment Time</th> <!-- Column for the expand icon -->
                <th></th>
            </tr>
        </thead>
        <tbody>
            <!-- Table data will be inserted here with JavaScript -->
        </tbody>
    </table>
    <!-- Pagination control -->
    <div id="pagination" class="mt-3">
        <button id="prev" class="btn btn-primary">Previous</button>
        <span id="page-info" class="mx-2"></span>
        <button id="next" class="btn btn-primary">Next</button>
    </div>
</div>
<style>
    .grade-1 { background-color: rgb(233 81 81); }
    .grade-2 { background-color: rgb(204, 159, 75); }
    .grade-3, .grade-0 { background-color: rgb(65, 119, 65); }
</style>
<script>
    var currentPage = 1;
    // Add click event to cancel button
    function cancelAppointment(appointmentId) {
        // Call the cancel appointment API
        url = "/appointment/"+ appointmentId + "/cancel"
        $.post(url, 
            function(response) {
                if (response.status == "success") {
                    // Reload the appointments list
                    loadAppointments();
                } else {
                    // Show an error message
                    alert('Failed to cancel appointment. Please try again.');
                }
            });
    }

    function loadAppointments() {
        $.get('{{ url_for('appointment.list_appointments') }}', { page: currentPage }, function(data) {
            // Clear the current list of appointments
            $('#appointmentsTable tbody').empty();

            // Group appointments by appointment time
            var groupedAppointments = {};
            $.each(data.appointments, function(i, appointment) {
                var date = new Date(appointment.appointment_time);
                var formattedDate = date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric', year: 'numeric' });

                if (!groupedAppointments[formattedDate]) {
                    groupedAppointments[formattedDate] = [];
                }

                groupedAppointments[formattedDate].push(appointment);
            });

            // Add the grouped appointments to the table
            $.each(groupedAppointments, function(dt, appointments) {
                var date = new Date(dt);
                var formattedDate = date.toLocaleString('en-IN', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                var dateRow = $('<tr><td colspan="6">' + formattedDate + '</td></tr>');
                $('#appointmentsTable tbody').append(dateRow);

                $.each(appointments, function(i, appointment) {
                    var date = new Date(appointment.appointment_time);
                    var formattedDate = date.toLocaleString('en-IN', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    var row = $(
                        '<tr class="grade-' + appointment.grade + '">' +
                        '<td></td>' +
                        '<td>' + (appointment.opportunity_name ? '<a style="color: #c8cdd5" href="/opportunity/' + appointment.opportunity_id + '">' + appointment.opportunity_name + '</a>' : appointment.name) + '</td>' +
                        '<td><ul class="list-inline mb-1"><li class="list-inline-item mb-1"><span><a type="button" class="btn btn-success" href="tel:' + appointment.telephone + '"><i class="bi bi-telephone"></i>' + 
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-telephone" viewBox="0 0 16 16">' 
                                        +'<path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z"/>' 
                                    +'</svg>' +
                                '</span></a></li><li class="list-inline-item mb-1"><span>' +
                                    '<a type="button" class="btn btn-success" target="WhatsApp" href="https://wa.me/' + appointment.telephone + '"><i class="bi bi-whatsapp"></i>' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp" viewBox="0 0 16 16">' +
                                '<path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/>' +
                                '</svg></a></span></li></ul></td>'+
                        '<td style="color: #c8cdd5">' + appointment.mentor_name + '</td>' +
                        '<td style="color: #c8cdd5">' + formattedDate + (appointment.conflicted ? ' <i class="bi bi-exclamation-triangle-fill" style="color: blue;"></i><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="blue" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">' +
                        '<path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>'+
                        '</svg>' : '') + '</td>' +
                        '<td><button class="btn btn-info btn-sm expand mb-2">See Details</button>' +
                        '<button id="canceled" class="btn btn-danger btn-sm mb-2" onclick="cancelAppointment('+ appointment.id +')">Mark as Canceled</button></td>' +
                        '</tr>'
                    );

                    var details = $(
                        '<tr class="details" style="display: none;">' +
                        '<td colspan="5">' +
                        '<strong>Career Challenge:</strong> ' + appointment.career_challenge + '<br>' +
                        '<strong>Challenge Description:</strong> ' + appointment.challenge_description + '<br>' +
                        '<strong>Urgency:</strong> ' + appointment.urgency + '<br>' +
                        '<strong>Salary Range:</strong> ' + appointment.salary_range + '<br>' +
                        '<strong>Expected Salary:</strong> ' + appointment.expected_salary + '<br>' +
                        '<strong>Current Employer:</strong> ' + appointment.current_employer + '<br>' +
                        '<strong>Financial Situation:</strong> ' + appointment.financial_situation +
                        '</td>' +
                        '</tr>'
                    );

                    $('#appointmentsTable tbody').append(row, details);
                });
            });

            // Update the pagination info
            $('#page-info').text('Page ' + data.page + ' of ' + data.total_pages);

            // Add click event to expand buttons
            $('.expand').click(function() {
                $(this).closest('tr').next('.details').toggle();
            });

            
           
        });
    }

    $(document).ready(function() {
        loadAppointments();

        $('#prev').click(function() {
            if (currentPage > 1) {
                currentPage--;
                loadAppointments();
            }
        });

        $('#next').click(function() {
            currentPage++;
            loadAppointments();
        });
    });
</script>
{% endblock %}