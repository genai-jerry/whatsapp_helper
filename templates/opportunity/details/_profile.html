<form action="update" method="POST">
    <input type="hidden" class="form-control" id="id" name="id" value="{{ opportunity.id }}">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" class="form-control" id="name" name="name" value="{{ opportunity.name }}">
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" class="form-control" id="email" name="email" value="{{ opportunity.email }}">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <label for="phone">Phone:</label>
            <div class="input-group">
                <span class="input-group-text" id="basic-addon1">
                    <a href="tel:{{opportunity.phone}}">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-telephone" viewBox="0 0 16 16" data-bs-toggle="tooltip" data-bs-placement="top" title="Call">
  <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z"></path>
</svg></a>
                </span>
                <span class="input-group-text" id="basic-addon1">
                    <a href="https://wa.me/{{opportunity.phone}}" target="_blank">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="green" class="bi bi-whatsapp" viewBox="0 0 16 16" data-bs-toggle="tooltip" data-bs-placement="top" title="WhatsApp">
  <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"></path>
</svg></a>
                </span>
                <input type="text" class="form-control" id="phone" name="phone" value="{{ opportunity.phone }}">
              </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="address">Postal Address:</label>
                <textarea class="form-control" id="address" name="address">{{ opportunity.address }}</textarea>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label for="state">Tax Jurisdiction:</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="same_state" name="same_state" {% if opportunity.same_state %}checked{% endif %}>
                    <label class="form-check-label" for="same_state">
                        Within State
                    </label>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label for="name">GST:</label>
                <input type="text" class="form-control" id="gst" name="gst" value="{{ opportunity.gst }}">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label for="gender">Gender:</label>
                <select class="form-control" id="gender" name="gender">
                    <option value="-1">Select a Gender</option>
                    <option value="male" {% if opportunity.gender == 'male' %}selected="selected"{% endif %}>Male</option>
                    <option value="female" {% if opportunity.gender == 'female' %}selected="selected"{% endif %}>Female</option>
                    <option value="other" {% if opportunity.gender == 'other' %}selected="selected"{% endif %}>Other</option>
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="companyType">Company Type:</label>
                <select class="form-control" id="companyType" name="company_type">
                    <option value="-1">Select a Company Type</option>
                    {% for type in company_types %}
                        <option value="{{ type.id }}" {% if opportunity.company_type == type.id %}selected="selected"{% endif %}>{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="challengeType">Challenge Type:</label>
                <select class="form-control" id="challengeType" name="challenge_type">
                    <option value="-1">Select a Challenge Type</option>
                    {% for type in challenge_types %}
                        <option value="{{ type.id }}" {% if opportunity.challenge_type == type.id %}selected="selected"{% endif %}>{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label for="callStatus">Opt-in Call Status:</label>
                <select class="form-control" id="callStatus" name="call_status">
                    <option value="-1">Select a Call Status</option>
                    {% for status in call_statuses %}
                        <option value="{{ status.id }}" {% if opportunity.call_status == status.id %}selected="selected"{% endif %}>{{ status.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="optinCaller">Optin Caller</label>
                <select class="form-control" id="optinCaller" name="optin_caller">
                    <option value="-1">Select the Caller</option>
                    {% for agent in sales_agents %}
                        <option value="{{ agent.id }}" {% if opportunity.optin_caller == agent.id %}selected{% endif %}>{{ agent.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="callSetter">Sales Call Set By</label>
                <select class="form-control" id="callSetter" name="call_setter">
                    <option value="-1">Select the Call Setter</option>
                    {% for agent in sales_agents %}
                        <option value="{{ agent.id }}" {% if opportunity.call_setter == agent.id %}selected{% endif %}>{{ agent.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            &nbsp;
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <h3>Actions</h3>
            <div class="action-buttons-container">
                <div class="btn-group" role="group" aria-label="Task and Comment Actions">
                    <button type="button" class="btn btn-primary btn-sm task-comment-btn border border-white" onclick="listTasks('{{ opportunity.id }}', '{{ opportunity.name }}')" title="List Tasks">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list-task" viewBox="0 0 16 16" data-bs-toggle="tooltip" data-bs-placement="top">
                            <path fill-rule="evenodd" d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM3 3H2v1h1V3z"/>
                            <path d="M5 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM5.5 7a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 4a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9z"/>
                            <path fill-rule="evenodd" d="M1.5 7a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5V7zM2 7h1v1H2V7zm0 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5H2zm1 .5H2v1h1v-1z"/>
                        </svg>
                    </button>
                    <button type="button" class="btn btn-primary btn-sm task-comment-btn border border-white" onclick="showCreateTaskModal('{{ opportunity.id }}', '{{ opportunity.name }}')" title="Create Task">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16" data-bs-toggle="tooltip" data-bs-placement="top">
                            <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                    </button>
                    <button type="button" class="btn btn-primary btn-sm task-comment-btn border border-white" onclick="listComments('{{ opportunity.id }}', '{{ opportunity.name }}')" title="List Comments">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-left-text" viewBox="0 0 16 16" data-bs-toggle="tooltip" data-bs-placement="top" title="List Comments">
                            <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                            <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                        </svg> 
                    </button>
                    <button type="button" class="btn btn-primary btn-sm task-comment-btn border border-white" onclick="showCreateCommentModal('{{ opportunity.id }}', '{{ opportunity.name }}')" title="Create Comment">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-right-quote" viewBox="0 0 16 16" data-bs-toggle="tooltip" data-bs-placement="top" title="Create Comment">
                            <path d="M2 1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h9.586a2 2 0 0 1 1.414.586l2 2V2a1 1 0 0 0-1-1H2zm12-1a2 2 0 0 1 2 2v12.793a.5.5 0 0 1-.854.353l-2.853-2.853a1 1 0 0 0-.707-.293H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h12z"/>
                            <path d="M7.066 4.76A1.665 1.665 0 0 0 4 5.668a1.667 1.667 0 0 0 2.561 1.406c-.131.389-.375.804-.777 1.22a.417.417 0 1 0 .6.58c1.486-1.54 1.293-3.214.682-4.112zm4 0A1.665 1.665 0 0 0 8 5.668a1.667 1.667 0 0 0 2.561 1.406c-.131.389-.375.804-.777 1.22a.417.417 0 1 0 .6.58c1.486-1.54 1.293-3.214.682-4.112z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% raw %}
    <script>
        function update_status(opportunity_id, status_id){
            $.ajax({
                url: '/opportunity/status/' + opportunity_id + '/opportunity_status',
                type: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({ status: status_id }),
                success: function(response) {
                    if (response.status == 'success') {
                        location.reload();
                    } else {
                        alert('Failed to update status. Please try again.');
                    }
                }
            });
        }            

        $('#messageTemplate').change(function() {
            var templateId = $(this).val();
            $.get('/template/' + templateId, function(template) {
                var templateInput = $('#templateInput');
                var placeholderInputs = $('#placeholderInputs');
                placeholderInputs.empty();
                templateInput.empty();
                if (template.template_text !== 'None') {
                    templateInput.append('<p><strong>Template:</strong> ' + template.template_text + '</p>');
                } else {
                    templateInput.append('<p><strong>Template:</strong> No Template</p>');
                }
                var placeholders = [...new Set(template.template_text.match(/{\s*(\w+)\s*}/g))].map(placeholder => placeholder.replace(/[{}]/g, ''));
                if (!placeholders) {
                    return;
                }
                placeholders.forEach(function(placeholder) {
                    var inputField = '<input class="form-control" type="text" name="' + placeholder + '" placeholder="' + placeholder + '"></input>';
                    placeholderInputs.append(inputField);
                });
            });
        });
    </script>
    {% endraw %}
    <script>
        $('#messageForm').submit(function(e) {
            e.preventDefault();
            var formData = {};
            $('#messageForm').find('input').each(function() {
                formData[$(this).attr('name')] = $(this).val();
            });
            $('#messageForm').find('select').each(function() {
                formData[$(this).attr('name')] = $(this).val();
            });
            var jsonData = JSON.stringify(formData);
            
            $.ajax({
                url: 'message',
                type: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: jsonData,
                success: function(message) {
                    var newCard = $(
                        '<div class="col-md-3 mb-4">' +
                            '<div class="card">' +
                                '<h5 class="card-header">' + (message.template ? message.template : "No Template") + '</h5>' +
                                '<div class="card-body">' +
                                    '<p class="card-text">Date Sent: ' + new Date(message.create_time).toLocaleString({ month: 'short', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) + '</p>' +
                                '</div>' +
                                '<div class="card-footer ' + (message.status == 'Sent' ? 'bg-success' : (message.status == 'Pending' ? 'bg-warning' : 'bg-danger')) + '">' + message.status + '</div>' +
                            '</div>' +
                        '</div>'
                    );
                    
                    // Append the new card to the messageinformation card deck
                    $('#messagingInformation .row').prepend(newCard);
                }
            });
        });
    </script>
</form>

<style>
    .action-buttons-container {
        margin-top: 10px;
    }
    .action-buttons-container .btn-group {
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .action-buttons-container .btn {
        padding: 0.375rem 0.75rem;
    }
</style>
