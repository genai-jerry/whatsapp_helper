<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Instance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <div class="container mt-5">
        <h2>Create New WhatsApp Instance</h2>
        <form id="newInstanceForm">
            <div class="mb-3">
                <label for="mobileNumber" class="form-label">Mobile Number</label>
                <input type="text" class="form-control" id="mobileNumber" required>
            </div>
            <div class="mb-3">
                <label for="userName" class="form-label">User Name</label>
                <input type="text" class="form-control" id="userName" required>
            </div>
            <div id="qrCodeContainer" class="mt-4" style="display: none;">
                <p>Scan the QR Code to activate instance</p>
                <!-- QR Code Image will be dynamically inserted here -->
                <div class="text-center">
                    <i onclick="checkQRCode()" class="bi bi-arrow-clockwise" style="font-size: 48px;"></i>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Add</button>
            <button type="button" class="btn btn-secondary" onclick="window.history.back();">Cancel</button>
        </form>
    </div>

    <script>
        $(document).ready(function() {
            $('#newInstanceForm').submit(function(event) {
                event.preventDefault();
                var mobileNumber = $('#mobileNumber').val();
                var userName = $('#userName').val();

                // Post to create instance
                $.post({
                    url: '/register/qr',
                    data: JSON.stringify({ 
                        mobileNumber: mobileNumber, 
                        userName: userName 
                    }),
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("Content-Type", "application/json");
                    },
                    success: function(response) {
                        if(response.status == 'pending'){
                            // Handle success
                            checkQRCode(mobileNumber)
                        }else{
                            window.location.href = '/'; // Redirect to the instances page
                        }
                    },
                    error: function(xhr, status, error) {
                        // Handle error
                    }
                });

            });

            function checkQRCode(mobileNumber) {
                if(mobileNumber == undefined){
                    mobileNumber = $('#mobileNumber').val();
                }
                $('#qrCodeContainer').show();
                $.getJSON("/register/qr?mobile_number=" + mobileNumber, function(data) {
                    if (data.status === 'ready') {
                        $('#qrCodeContainer').html('<img width="264px" height="264px" src="/qr/image?mobile_number='+mobileNumber+'" alt="QR Code">');
                        checkActivation(mobileNumber);
                    } else {
                        setTimeout(function() { checkQRCode(mobileNumber); }, 5000);
                    }
                });
            }

            function checkActivation(mobileNumber) {
                $.getJSON("/register/qr/active?mobile_number=" + mobileNumber, function(data) {
                    if (data.status === 'ready') {
                        window.location.href = '/'; // Redirect to the instances page
                    } else {
                        setTimeout(function() { checkActivation(mobileNumber); }, 5000);
                    }
                });
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
